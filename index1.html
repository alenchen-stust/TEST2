<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鐘錶眼鏡客戶管理系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PapaParse (CSV Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            addDoc,
            deleteDoc,
            updateDoc,
            getDocs, 
            query, 
            where,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
            getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc, getDocs, query, where, onSnapshot
        };
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // *** 設定：Google Apps Script 網頁應用程式網址 ***
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzcbRhUDh4UsPA0Mn7QnKsD0hkLeo-xrTXb2LHwKLUZHuYOBfGh-xVYeNyIoJXHxQT9/exec"; 

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxtxWF-jQMMxvAeMjP5-HJ6y6_QBxLdsY",
            authDomain: "test1-1246d.firebaseapp.com",
            projectId: "test1-1246d",
            storageBucket: "test1-1246d.firebasestorage.app",
            messagingSenderId: "1046567528056",
            appId: "1:1046567528056:web:4e34594985c21d8892af8d",
            measurementId: "G-8JNGR22WDW"
        };

        // --- Initialize Firebase ---
        const { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } = window.firebaseModules;
        const { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc, getDocs, query, where, onSnapshot } = window.firebaseModules;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- API Services (Google Sheets) ---
        const apiService = {
            read: async (sheet) => {
                const res = await fetch(`${GAS_API_URL}?action=read&sheet=${sheet}`);
                const json = await res.json();
                return json.status === 'success' && Array.isArray(json.data) ? json.data : [];
            },
            create: async (sheet, data) => {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'create', sheet, data })
                });
                return await res.json();
            },
            update: async (sheet, id, data) => {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'update', sheet, id, data })
                });
                return await res.json();
            },
            delete: async (sheet, id) => {
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete', sheet, id })
                });
                return await res.json();
            }
        };

        // --- Icons ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>;
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
        const Edit = (props) => <Icon {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>;
        const LogOut = (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></Icon>;
        const FileSpreadsheet = (props) => <Icon {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></Icon>;
        const Database = (props) => <Icon {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></Icon>;
        const Eye = (props) => <Icon {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></Icon>;
        const Lock = (props) => <Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></Icon>;

        // --- Taiwan City Data ---
        const TAIWAN_CITIES = {
            "臺北市": ["中正區", "大同區", "中山區", "松山區", "大安區", "萬華區", "信義區", "士林區", "北投區", "內湖區", "南港區", "文山區"],
            "新北市": ["板橋區", "新莊區", "中和區", "永和區", "土城區", "樹林區", "三峽區", "鶯歌區", "三重區", "蘆洲區", "五股區", "泰山區", "林口區", "淡水區", "八里區", "三芝區", "石門區", "汐止區", "金山區", "萬里區", "瑞芳區", "平溪區", "雙溪區", "貢寮區", "新店區", "坪林區", "烏來區", "深坑區", "石碇區"],
            "基隆市": ["仁愛區", "信義區", "中正區", "中山區", "安樂區", "暖暖區", "七堵區"],
            "桃園市": ["桃園區", "中壢區", "大溪區", "楊梅區", "蘆竹區", "大園區", "龜山區", "八德區", "龍潭區", "平鎮區", "新屋區", "觀音區", "復興區"],
            "新竹市": ["東區", "北區", "香山區"],
            "新竹縣": ["竹北市", "竹東鎮", "新埔鎮", "關西鎮", "湖口鄉", "新豐鄉", "芎林鄉", "橫山鄉", "北埔鄉", "寶山鄉", "峨眉鄉", "尖石鄉", "五峰鄉"],
            "苗栗縣": ["苗栗市", "頭份市", "竹南鎮", "後龍鎮", "通霄鎮", "苑裡鎮", "卓蘭鎮", "造橋鄉", "西湖鄉", "頭屋鄉", "公館鄉", "銅鑼鄉", "三義鄉", "大湖鄉", "獅潭鄉", "泰安鄉", "南庄鄉"],
            "臺中市": ["中區", "東區", "南區", "西區", "北區", "北屯區", "西屯區", "南屯區", "太平區", "大里區", "霧峰區", "烏日區", "豐原區", "后里區", "石岡區", "東勢區", "和平區", "新社區", "潭子區", "大雅區", "神岡區", "大肚區", "沙鹿區", "龍井區", "梧棲區", "清水區", "大甲區", "外埔區", "大安區"],
            "彰化縣": ["彰化市", "員林市", "和美鎮", "鹿港鎮", "溪湖鎮", "二林鎮", "田中鎮", "北斗鎮", "花壇鄉", "芬園鄉", "大村鄉", "埔心鄉", "永靖鄉", "社頭鄉", "二水鄉", "田尾鄉", "埤頭鄉", "芳苑鄉", "大城鄉", "竹塘鄉", "溪州鄉", "秀水鄉", "福興鄉", "線西鄉", "伸港鄉", "埔鹽鄉"],
            "南投縣": ["南投市", "埔里鎮", "草屯鎮", "竹山鎮", "集集鎮", "名間鄉", "鹿谷鄉", "中寮鄉", "魚池鄉", "國姓鄉", "水里鄉", "信義鄉", "仁愛鄉"],
            "雲林縣": ["斗六市", "斗南鎮", "虎尾鎮", "西螺鎮", "土庫鎮", "北港鎮", "古坑鄉", "大埤鄉", "莿桐鄉", "林內鄉", "二崙鄉", "崙背鄉", "麥寮鄉", "東勢鄉", "褒忠鄉", "臺西鄉", "元長鄉", "四湖鄉", "口湖鄉", "水林鄉"],
            "嘉義市": ["東區", "西區"],
            "嘉義縣": ["太保市", "朴子市", "布袋鎮", "大林鎮", "民雄鄉", "溪口鄉", "新港鄉", "六腳鄉", "東石鄉", "義竹鄉", "鹿草鄉", "水上鄉", "中埔鄉", "竹崎鄉", "梅山鄉", "番路鄉", "大埔鄉", "阿里山鄉"],
            "臺南市": ["中西區", "東區", "南區", "北區", "安平區", "安南區", "永康區", "歸仁區", "新化區", "左鎮區", "玉井區", "楠西區", "南化區", "仁德區", "關廟區", "龍崎區", "官田區", "麻豆區", "佳里區", "西港區", "七股區", "將軍區", "學甲區", "北門區", "新營區", "後壁區", "白河區", "東山區", "六甲區", "下營區", "柳營區", "鹽水區", "善化區", "大內區", "山上區", "新市區", "安定區"],
            "高雄市": ["楠梓區", "左營區", "鼓山區", "三民區", "鹽埕區", "前金區", "新興區", "苓雅區", "前鎮區", "旗津區", "小港區", "鳳山區", "林園區", "大寮區", "大樹區", "大社區", "仁武區", "鳥松區", "岡山區", "橋頭區", "燕巢區", "田寮區", "阿蓮區", "路竹區", "湖內區", "茄萣區", "永安區", "彌陀區", "梓官區", "旗山區", "美濃區", "六龜區", "甲仙區", "杉林區", "內門區", "茂林區", "桃源區", "那瑪夏區"],
            "屏東縣": ["屏東市", "潮州鎮", "東港鎮", "恆春鎮", "萬丹鄉", "長治鄉", "麟洛鄉", "九如鄉", "里港鄉", "鹽埔鄉", "高樹鄉", "萬巒鄉", "內埔鄉", "竹田鄉", "新埤鄉", "枋寮鄉", "新園鄉", "崁頂鄉", "林邊鄉", "南州鄉", "佳冬鄉", "琉球鄉", "車城鄉", "滿州鄉", "枋山鄉", "三地門鄉", "霧臺鄉", "瑪家鄉", "泰武鄉", "來義鄉", "春日鄉", "獅子鄉", "牡丹鄉"],
            "宜蘭縣": ["宜蘭市", "羅東鎮", "蘇澳鎮", "頭城鎮", "礁溪鄉", "壯圍鄉", "員山鄉", "冬山鄉", "五結鄉", "三星鄉", "大同鄉", "南澳鄉"],
            "花蓮縣": ["花蓮市", "鳳林鎮", "玉里鎮", "新城鄉", "吉安鄉", "壽豐鄉", "光復鄉", "豐濱鄉", "瑞穗鄉", "富里鄉", "秀林鄉", "萬榮鄉", "卓溪鄉"],
            "臺東縣": ["臺東市", "成功鎮", "關山鎮", "卑南鄉", "大武鄉", "太麻里鄉", "東河鄉", "長濱鄉", "鹿野鄉", "池上鄉", "綠島鄉", "蘭嶼鄉", "延平鄉", "金峰鄉", "達仁鄉", "海端鄉"],
            "澎湖縣": ["馬公市", "湖西鄉", "白沙鄉", "西嶼鄉", "望安鄉", "七美鄉"],
            "金門縣": ["金城鎮", "金湖鎮", "金沙鎮", "金寧鄉", "烈嶼鄉", "烏坵鄉"],
            "連江縣": ["南竿鄉", "北竿鄉", "莒光鄉", "東引鄉"]
        };

        const COMMON_ROADS = [
            "中正路", "中山路", "中華路", "中華東路", "中華西路", "中華北路", "中華南路",
            "民族路", "民權路", "民生路", "成功路", "西門路", "北門路", "東門路", "南門路",
            "大同路", "開元路", "長榮路", "林森路", "東寧路", "裕農路", "小東路", "海安路",
            "金華路", "安平路", "安和路", "安中路", "北安路", "大灣路", "永大路", "中興路", "復興路"
        ];

        // --- Constants ---
        const CMF_FIELDS = [
            { key: 'CID1', label: '客戶編號', type: 'text', required: true },
            { key: 'NAME', label: '客戶姓名', type: 'text', required: true },
            { key: 'SEX', label: '性別', type: 'select', options: ['男', '女', '其他'] },
            { key: 'TEL', label: '電話', type: 'tel' },
            { key: 'BIRDATE', label: '生日', type: 'date' },
            { key: 'ADDRESS', label: '地址', type: 'address', className: 'col-span-2' },
            { key: 'INDATE', label: '初訪日期', type: 'date' },
            { key: 'LASTD', label: '最後日期', type: 'date' },
            { key: 'CLASS', label: '備考', type: 'text' },
            { key: 'CLASS1', label: '備考1', type: 'text' },
            { key: 'SUM', label: '總計', type: 'number' },
        ];

        const PRXMF_FIELDS_KEYS = ['DATE', 'RSPH', 'RCYL', 'RAXIS', 'RADD', 'RBCV', 'RBCH', 'LSPH', 'LCYL', 'LAXIS', 'LADD', 'LBCV', 'LBCH', 'PD', 'ITEM', 'RITEM', 'LITEM', 'RBRVISE1', 'LBRVISE1', 'RBRVISE2', 'LBRVISE2', 'REMARK', 'REMARK2', 'REMARK3', 'AGE', 'NUM'];

        // --- Utility Components ---
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        );

        const Modal = ({ title, onClose, children, size = 'default' }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className={`bg-white rounded-lg shadow-xl w-full ${size === 'large' ? 'max-w-6xl' : 'max-w-4xl'} max-h-[90vh] overflow-y-auto`}>
                    <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                        <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div className="p-6">
                        {children}
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [userRole, setUserRole] = useState(null);
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('search');
            
            const [customers, setCustomers] = useState([]);
            const [allPrescriptions, setAllPrescriptions] = useState([]); 
            const [filteredCustomers, setFilteredCustomers] = useState([]);
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [customerPrescriptions, setCustomerPrescriptions] = useState([]);
            
            const [searchCriteria, setSearchCriteria] = useState({ CID1: '', NAME: '', TEL: '', ADDRESS: '', BIRDATE: '' });
            const [hasSearched, setHasSearched] = useState(false);

            const [isCustomerModalOpen, setIsCustomerModalOpen] = useState(false);
            const [isPrxModalOpen, setIsPrxModalOpen] = useState(false);
            const [editingData, setEditingData] = useState({});
            const [mode, setMode] = useState('add');
            const [isViewOnly, setIsViewOnly] = useState(false); 

            const [addrCity, setAddrCity] = useState('臺南市'); 
            const [addrDist, setAddrDist] = useState('');
            const [addrRoad, setAddrRoad] = useState('');
            const [addrDetail, setAddrDetail] = useState('');

            const [systemUsers, setSystemUsers] = useState([]);
            const [msg, setMsg] = useState({ text: '', type: '' });
            const [authError, setAuthError] = useState(null);

            // *** Optimization: Memoize Prescription Counts ***
            const prxCounts = useMemo(() => {
                const counts = {};
                allPrescriptions.forEach(p => {
                    const id = String(p.CID1 || '').trim();
                    if(id) counts[id] = (counts[id] || 0) + 1;
                });
                return counts;
            }, [allPrescriptions]);

            // --- Auth ---
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        // Use Firestore for permissions
                        const adminRef = collection(db, 'artifacts', appId, 'public', 'data', 'sys_users');
                        const PREDEFINED_ADMINS = ['alenchen@stust.edu.tw', 'v1277.chen@gmail.com.tw'];
                        
                        try {
                            const snapshot = await getDocs(adminRef);
                            const allUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            const myUser = allUsers.find(u => u.email === currentUser.email);
                            
                            let currentRole = 'pending'; 
                            if (PREDEFINED_ADMINS.includes(currentUser.email)) currentRole = 'admin';
                            else if (myUser) currentRole = myUser.role || 'pending'; 

                            // Critical: Ensure predefined admins are restored even if DB wiped
                            if (!myUser) {
                                try {
                                    await addDoc(adminRef, { email: currentUser.email, role: currentRole, addedAt: new Date().toISOString() });
                                } catch(e) {
                                    console.error("Failed to auto-register user (check rules):", e);
                                    // Even if write fails, grant local admin for predefined
                                    if(PREDEFINED_ADMINS.includes(currentUser.email)) currentRole = 'admin';
                                }
                            } else if (PREDEFINED_ADMINS.includes(currentUser.email) && myUser.role !== 'admin') {
                                try {
                                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sys_users', myUser.id), { role: 'admin' });
                                } catch(e) { console.error("Failed to update admin role:", e); }
                            }

                            setUserRole(currentRole);
                            setIsAdmin(currentRole === 'admin');
                        } catch (err) { 
                            console.error("Auth Error", err);
                            // Fallback for predefined admins if DB read fails completely
                            if(PREDEFINED_ADMINS.includes(currentUser.email)) {
                                setUserRole('admin');
                                setIsAdmin(true);
                            }
                        }
                    } else {
                        setIsAdmin(false); setUserRole(null); setCustomers([]); setAllPrescriptions([]); setSelectedCustomer(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // --- Fetch Data ---
            const fetchData = async () => {
                if (!GAS_API_URL) return;
                setLoading(true);
                try {
                    const [cData, pData] = await Promise.all([apiService.read('CMF'), apiService.read('PRXMF')]);
                    setCustomers(Array.isArray(cData) ? cData : []);
                    setAllPrescriptions(Array.isArray(pData) ? pData : []);
                } catch (e) { showMsg("資料讀取失敗", "error"); } finally { setLoading(false); }
            };

            useEffect(() => { if (user && userRole !== 'pending') fetchData(); }, [user, userRole]);

            useEffect(() => {
                if (selectedCustomer && allPrescriptions.length > 0) {
                    const matches = allPrescriptions.filter(p => String(p.CID1).trim() === String(selectedCustomer.CID1).trim());
                    matches.sort((a, b) => new Date(b.DATE) - new Date(a.DATE));
                    setCustomerPrescriptions(matches);
                } else { setCustomerPrescriptions([]); }
            }, [selectedCustomer, allPrescriptions]);

            // --- Handlers ---
            const handleGoogleLogin = async () => {
                setAuthError(null);
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } 
                catch (error) {
                    if (error.code === 'auth/unauthorized-domain') {
                        let domain = window.location.hostname;
                        if(window.location.protocol === 'blob:') try { domain = new URL(window.location.href.replace('blob:', '')).hostname; } catch(e){}
                        setAuthError({ type: 'domain', domain, fullUrl: window.location.href });
                    } else setAuthError({ type: 'other', message: error.message });
                }
            };
            const handleLogout = () => signOut(auth);

            const handleSearch = () => {
                const { CID1, NAME, TEL, ADDRESS, BIRDATE } = searchCriteria;
                const filtered = customers.filter(c => {
                    if (!c) return false;
                    const matchCID = CID1 ? String(c.CID1 || '').includes(CID1) : true;
                    const matchName = NAME ? String(c.NAME || '').toLowerCase().includes(NAME.toLowerCase()) : true;
                    const matchTel = TEL ? String(c.TEL || '').includes(TEL) : true;
                    const matchAddr = ADDRESS ? String(c.ADDRESS || '').toLowerCase().includes(ADDRESS.toLowerCase()) : true;
                    const matchBirth = BIRDATE ? c.BIRDATE === BIRDATE : true;
                    return matchCID && matchName && matchTel && matchAddr && matchBirth;
                });
                setFilteredCustomers(filtered);
                setHasSearched(true);
            };

            // CRUD
            const openCustomerModal = (c) => { 
                setMode(c ? 'edit' : 'add'); 
                setEditingData(c ? {...c} : {CID1:'', NAME:'', SEX:'男', INDATE: new Date().toISOString().split('T')[0], ADDRESS: ''}); 
                setAddrCity('臺南市'); setAddrDist(''); setAddrRoad(''); setAddrDetail(c ? (c.ADDRESS || '') : '');
                setIsCustomerModalOpen(true); 
            };

            const saveCustomer = async () => {
                if(!isAdmin) return;
                setLoading(true);
                const finalAddr = (addrCity + addrDist + addrRoad + addrDetail).trim();
                const dataToSave = { ...editingData, ADDRESS: finalAddr || editingData.ADDRESS };

                try {
                    let newCustomer = null;
                    if (mode === 'add') {
                        if (customers.some(c => c.CID1 === dataToSave.CID1)) { alert('編號重複'); setLoading(false); return; }
                        const res = await apiService.create('CMF', dataToSave);
                        if(res.status === 'success') newCustomer = res.data;
                    } else await apiService.update('CMF', dataToSave.id, dataToSave);
                    
                    setIsCustomerModalOpen(false); 
                    showMsg('儲存成功', 'success'); 
                    await fetchData(); 

                    if(mode === 'add' && newCustomer) {
                        setSelectedCustomer(newCustomer);
                        setTimeout(() => openPrxModal(null, newCustomer), 500); 
                    } else if (hasSearched) handleSearch();

                } catch(e) { showMsg('失敗', 'error'); } finally { setLoading(false); }
            };

            const deleteCustomer = async (id) => {
                if(!isAdmin || !confirm('確定刪除?')) return;
                setLoading(true);
                try { await apiService.delete('CMF', id); showMsg('刪除成功', 'success'); fetchData(); } catch(e) { showMsg('失敗', 'error'); } finally { setLoading(false); }
            };

            const openPrxModal = (p = null, customerOverride = null) => {
                const targetCustomer = customerOverride || selectedCustomer;
                if (!targetCustomer) return;
                
                const isView = !isAdmin && p !== null;
                setIsViewOnly(isView);

                setMode(p ? 'edit' : 'add');
                setEditingData(p ? {...p} : {
                    CID1: targetCustomer.CID1, 
                    NAME: targetCustomer.NAME, 
                    TEL: targetCustomer.TEL, 
                    DATE: new Date().toISOString().split('T')[0]
                });
                setIsPrxModalOpen(true);
            };

            const savePrx = async () => {
                if(!isAdmin) return;
                setLoading(true);
                try {
                    if (mode === 'add') await apiService.create('PRXMF', editingData);
                    else await apiService.update('PRXMF', editingData.id, editingData);
                    setIsPrxModalOpen(false); showMsg('儲存成功', 'success'); fetchData();
                } catch(e) { showMsg('失敗', 'error'); } finally { setLoading(false); }
            };

            const deletePrx = async (id) => {
                if(!isAdmin || !confirm('確定刪除?')) return;
                setLoading(true);
                try { await apiService.delete('PRXMF', id); showMsg('刪除成功', 'success'); fetchData(); } catch(e) { showMsg('失敗', 'error'); } finally { setLoading(false); }
            };

            // Admin
            const fetchSystemUsers = async () => {
                if(!isAdmin) return;
                setLoading(true);
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'sys_users');
                const snap = await getDocs(q);
                setSystemUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                setLoading(false);
            };
            const addUser = async (email) => { if (!email) return; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sys_users'), {email, role:'user', addedAt: new Date().toISOString()}); fetchSystemUsers(); };
            const removeUser = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sys_users', id)); fetchSystemUsers(); };
            const updateUserRole = async (id, role) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sys_users', id), {role}); showMsg('已更新', 'success'); fetchSystemUsers(); };

            // CSV Export
            const exportCSV = (type) => {
                const data = type === 'CMF' ? customers : allPrescriptions;
                if (!data.length) { alert('無資料'); return; }
                const sorted = [...data].sort((a, b) => String(a.CID1||'').localeCompare(String(b.CID1||''), undefined, {numeric: true}));
                const today = new Date().toISOString().split('T')[0];
                const filename = `${type}_${today}.csv`;
                let exportHeaders = type === 'CMF' ? CMF_FIELDS.map(f => f.key) : ['CID1', 'NAME', ...PRXMF_FIELDS_KEYS];
                const content = [exportHeaders.join(','), ...sorted.map(row => exportHeaders.map(f => `"${String(row[f]||'').replace(/"/g,'""')}"`).join(','))].join('\n');
                const url = URL.createObjectURL(new Blob(["\uFEFF"+content], {type:'text/csv;charset=utf-8'}));
                const link = document.createElement("a"); link.href = url; link.download = filename; link.click();
            };

            const showMsg = (text, type) => { setMsg({ text, type }); setTimeout(() => setMsg({ text: '', type: '' }), 3000); };

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 relative">
                    {authError && (
                        <div className="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[80] p-4">
                            <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                                <h3 className="text-xl font-bold text-red-600 mb-4 flex items-center">⚠️ 網域授權錯誤</h3>
                                <div className="bg-gray-100 p-3 rounded text-lg font-mono border-2 border-blue-200 text-blue-800 select-all break-all mb-4">{authError.domain}</div>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => {navigator.clipboard.writeText(authError.domain); alert('已複製');}} className="px-4 py-2 bg-blue-100 text-blue-700 rounded">複製網域</button>
                                    <button onClick={() => setAuthError(null)} className="px-4 py-2 bg-gray-600 text-white rounded">關閉視窗</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="bg-white p-8 rounded shadow-lg max-w-md w-full">
                        <h1 className="text-2xl font-bold mb-4 text-center">鐘錶眼鏡客戶管理系統</h1>
                        <button onClick={handleGoogleLogin} className="w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded flex items-center justify-center hover:bg-gray-50 transition shadow-sm"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5 mr-2" /> 使用 Google 帳號登入</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col relative">
                    {loading && <div className="fixed inset-0 bg-black bg-opacity-30 z-[70] flex flex-col items-center justify-center text-white"><LoadingSpinner/><p className="text-lg font-bold">處理中...</p></div>}
                    
                    <header className="bg-blue-800 text-white p-4 shadow flex justify-between items-center">
                        <div className="text-xl font-bold flex items-center cursor-pointer" onClick={() => {setSelectedCustomer(null); setActiveTab('search');}}><Eye className="mr-2"/> 客戶管理系統</div>
                        <div className="flex items-center gap-4 text-sm">
                            <span>{user.email} <span className="bg-yellow-500 text-blue-900 px-1 rounded ml-1">{userRole === 'admin' ? '管理員' : userRole === 'pending' ? '未授權' : '使用者'}</span></span>
                            <button onClick={handleLogout}><LogOut/></button>
                        </div>
                    </header>

                    <nav className="bg-white shadow border-b flex">
                        <button className={`px-6 py-3 border-b-2 ${activeTab==='search'?'border-blue-600 text-blue-600':''}`} onClick={() => {setSelectedCustomer(null); setActiveTab('search');}}>客戶查詢</button>
                        {selectedCustomer && <button className="px-6 py-3 border-b-2 border-blue-600 text-blue-600">{selectedCustomer.NAME}</button>}
                        {isAdmin && <button className={`px-6 py-3 border-b-2 ${activeTab==='admin'?'border-blue-600 text-blue-600':''}`} onClick={() => {setSelectedCustomer(null); setActiveTab('admin'); fetchSystemUsers();}}>系統管理</button>}
                    </nav>

                    {msg.text && <div className={`fixed top-4 right-4 p-4 rounded shadow text-white z-50 ${msg.type==='success'?'bg-green-500':'bg-red-500'}`}>{msg.text}</div>}

                    <main className="flex-1 container mx-auto p-4 overflow-y-auto">
                        {userRole === 'pending' ? (
                            <div className="flex flex-col items-center justify-center h-full text-gray-500"><Lock className="w-16 h-16 mb-4"/><h2 className="text-2xl font-bold">帳號審核中</h2><p>請聯繫管理員開通權限。</p></div>
                        ) : activeTab === 'search' && !selectedCustomer ? (
                            <div className="space-y-6">
                                <div className="bg-white p-4 rounded shadow grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                                    <input placeholder="客戶編號" className="border p-2 rounded" value={searchCriteria.CID1} onChange={e=>setSearchCriteria({...searchCriteria, CID1:e.target.value})} />
                                    <input placeholder="姓名" className="border p-2 rounded" value={searchCriteria.NAME} onChange={e=>setSearchCriteria({...searchCriteria, NAME:e.target.value})} />
                                    <input placeholder="電話" className="border p-2 rounded" value={searchCriteria.TEL} onChange={e=>setSearchCriteria({...searchCriteria, TEL:e.target.value})} />
                                    <input placeholder="地址" className="border p-2 rounded" value={searchCriteria.ADDRESS} onChange={e=>setSearchCriteria({...searchCriteria, ADDRESS:e.target.value})} />
                                    <input type="date" className="border p-2 rounded" value={searchCriteria.BIRDATE} onChange={e=>setSearchCriteria({...searchCriteria, BIRDATE:e.target.value})} />
                                    <button onClick={handleSearch} className="bg-blue-600 text-white p-2 rounded flex justify-center items-center"><Search className="mr-1"/> 搜尋</button>
                                </div>
                                {hasSearched && (
                                    <div className="bg-white p-4 rounded shadow fade-in">
                                        <div className="flex justify-between mb-4"><h2 className="font-bold">結果 ({filteredCustomers.length})</h2>{isAdmin && <button onClick={()=>openCustomerModal()} className="bg-blue-600 text-white px-3 py-1 rounded flex items-center"><Plus className="w-4 mr-1"/> 新增</button>}</div>
                                        <table className="w-full">
                                            <thead className="bg-gray-50"><tr><th className="p-2 text-left">編號</th><th className="p-2 text-left">姓名</th><th className="p-2">性別</th><th className="p-2">電話</th><th className="p-2">生日</th><th className="p-2">驗光數</th><th className="p-2">操作</th></tr></thead>
                                            <tbody>
                                                {filteredCustomers.map(c => (
                                                    <tr key={c.id} className="border-t hover:bg-gray-50">
                                                        <td className="p-2">{c.CID1}</td>
                                                        <td className="p-2 text-blue-600 cursor-pointer" onClick={()=>setSelectedCustomer(c)}>{c.NAME}</td>
                                                        <td className="p-2 text-center">{c.SEX}</td><td className="p-2">{c.TEL}</td><td className="p-2">{c.BIRDATE}</td>
                                                        <td className="p-2 text-center font-bold">{prxCounts[String(c.CID1||'').trim()] || 0}</td>
                                                        <td className="p-2 flex gap-2">
                                                            <button onClick={()=>{setSelectedCustomer(c)}} className="text-blue-600" title="詳細資料"><FileText/></button>
                                                            {isAdmin && <><button onClick={()=>openCustomerModal(c)} className="text-green-600"><Edit/></button><button onClick={()=>deleteCustomer(c.id, c.CID1)} className="text-red-600"><Trash2/></button></>}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        ) : selectedCustomer ? (
                            <div className="space-y-6 fade-in">
                                <div className="bg-white p-6 rounded shadow-lg border-l-4 border-blue-600 relative">
                                    <div className="flex justify-between items-start mb-4">
                                        <h2 className="text-2xl font-bold text-gray-800">{selectedCustomer.NAME} <span className="text-lg text-gray-500 font-normal">({selectedCustomer.CID1})</span></h2>
                                        {isAdmin && <button onClick={()=>openCustomerModal(selectedCustomer)} className="text-blue-600 hover:bg-blue-50 p-2 rounded"><Edit className="w-5 h-5"/></button>}
                                    </div>
                                    <div className="grid md:grid-cols-3 gap-4 text-sm">
                                        <div>電話: {selectedCustomer.TEL}</div><div>生日: {selectedCustomer.BIRDATE}</div><div>性別: {selectedCustomer.SEX}</div>
                                        <div className="col-span-3">地址: {selectedCustomer.ADDRESS}</div>
                                        <div>初訪: {selectedCustomer.INDATE}</div><div>最後: {selectedCustomer.LASTD}</div><div>總計: {selectedCustomer.SUM}</div>
                                        <div className="col-span-3 bg-gray-50 p-2">備考: {selectedCustomer.CLASS} {selectedCustomer.CLASS1}</div>
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="flex justify-between mb-4 border-b pb-2"><h3 className="font-bold flex items-center"><Database className="mr-2"/> 驗光紀錄</h3>{isAdmin && <button onClick={()=>openPrxModal()} className="bg-green-600 text-white px-3 py-1 rounded flex items-center"><Plus className="w-4 mr-1"/> 新增驗光</button>}</div>
                                    <div className="space-y-4">
                                        {customerPrescriptions.map(p => (
                                            <div key={p.id} className="border rounded-lg p-4 hover:shadow-md bg-white">
                                                <div className="flex justify-between font-bold mb-3 border-b pb-1">
                                                    <span className="text-blue-800 text-lg">{p.DATE}</span>
                                                    <div className="flex gap-2">
                                                        <button onClick={()=>openPrxModal(p)} className="text-blue-600 text-sm flex items-center hover:bg-gray-100 p-1 rounded"><Eye className="w-4 h-4 mr-1"/> {isAdmin ? '編輯' : '詳細'}</button>
                                                        {isAdmin && <button onClick={()=>deletePrx(p.id)} className="text-red-600 text-sm flex items-center hover:bg-gray-100 p-1 rounded"><Trash2 className="w-4 h-4 mr-1"/> 刪除</button>}
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                    <div className="bg-red-50 p-3 rounded border border-red-100">
                                                        <div className="font-bold text-red-800 mb-2 border-b border-red-200">右眼 (R)</div>
                                                        <div className="grid grid-cols-4 gap-2">
                                                            <div><span className="text-gray-500 text-xs block">球面(SPH)</span>{p.RSPH}</div>
                                                            <div><span className="text-gray-500 text-xs block">散光(CYL)</span>{p.RCYL}</div>
                                                            <div><span className="text-gray-500 text-xs block">角度(AXIS)</span>{p.RAXIS}</div>
                                                            <div><span className="text-gray-500 text-xs block">老花(ADD)</span>{p.RADD}</div>
                                                        </div>
                                                    </div>
                                                    <div className="bg-blue-50 p-3 rounded border border-blue-100">
                                                        <div className="font-bold text-blue-800 mb-2 border-b border-blue-200">左眼 (L)</div>
                                                        <div className="grid grid-cols-4 gap-2">
                                                            <div><span className="text-gray-500 text-xs block">球面(SPH)</span>{p.LSPH}</div>
                                                            <div><span className="text-gray-500 text-xs block">散光(CYL)</span>{p.LCYL}</div>
                                                            <div><span className="text-gray-500 text-xs block">角度(AXIS)</span>{p.LAXIS}</div>
                                                            <div><span className="text-gray-500 text-xs block">老花(ADD)</span>{p.LADD}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="mt-3 text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                                    ITEM: {p.ITEM} | R-ITEM: {p.RITEM} | L-ITEM: {p.LITEM} | 備註: {p.REMARK}
                                                </div>
                                            </div>
                                        ))}
                                        {customerPrescriptions.length === 0 && <div className="text-center text-gray-400 py-4">尚無驗光紀錄</div>}
                                    </div>
                                </div>
                            </div>
                        ) : activeTab === 'admin' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded shadow grid md:grid-cols-2 gap-6">
                                    <div className="border p-4">
                                        <h3 className="font-bold mb-2 text-blue-600">客戶資料 (CMF)</h3>
                                        <button onClick={()=>exportCSV('CMF')} className="w-full bg-gray-100 py-2 mb-2 rounded">匯出 CSV</button>
                                    </div>
                                    <div className="border p-4">
                                        <h3 className="font-bold mb-2 text-green-600">驗光資料 (PRXMF)</h3>
                                        <button onClick={()=>exportCSV('PRXMF')} className="w-full bg-gray-100 py-2 mb-2 rounded">匯出 CSV</button>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded shadow">
                                    <h2 className="font-bold mb-4">使用者權限管理</h2>
                                    <div className="flex gap-2 mb-4"><input id="u_email" placeholder="Email" className="border p-2 flex-1 rounded"/><button onClick={()=>{addUser(document.getElementById('u_email').value)}} className="bg-blue-600 text-white px-4 rounded">新增</button></div>
                                    <ul className="divide-y">{systemUsers.map(u => (<li key={u.id} className="py-2 flex justify-between items-center"><span>{u.email} ({u.role})</span><div className="flex gap-2"><select value={u.role} onChange={e=>updateUserRole(u.id, e.target.value)} className="border"><option value="pending">未授權</option><option value="user">使用者</option><option value="admin">管理員</option></select><button onClick={()=>removeUser(u.id)} className="text-red-600">刪除</button></div></li>))}</ul>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Customer Modal */}
                    {isCustomerModalOpen && (
                        <Modal title={mode === 'add' ? "新增客戶" : "編輯客戶"} onClose={() => setIsCustomerModalOpen(false)}>
                            <form onSubmit={(e) => { e.preventDefault(); saveCustomer(); }} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {CMF_FIELDS.map(field => (
                                    <div key={field.key} className={field.className}>
                                        <label className="block text-sm font-bold text-gray-500 mb-1">{field.label}</label>
                                        {field.key === 'ADDRESS' ? (
                                            <div className="space-y-2">
                                                <div className="flex space-x-2">
                                                    <select className="border p-1 rounded w-1/3" value={addrCity} onChange={e => {setAddrCity(e.target.value); setAddrDist('');}}>
                                                        <option value="">縣市</option>
                                                        {Object.keys(TAIWAN_CITIES).map(c => <option key={c} value={c}>{c}</option>)}
                                                    </select>
                                                    <select className="border p-1 rounded w-1/3" value={addrDist} onChange={e => setAddrDist(e.target.value)}>
                                                        <option value="">鄉鎮市區</option>
                                                        {addrCity && TAIWAN_CITIES[addrCity]?.map(d => <option key={d} value={d}>{d}</option>)}
                                                    </select>
                                                    <div className="w-1/3">
                                                        <input list="common-roads" className="border p-1 rounded w-full" placeholder="道路 (可選/輸)" value={addrRoad} onChange={e => setAddrRoad(e.target.value)} />
                                                        <datalist id="common-roads">{COMMON_ROADS.map(r => <option key={r} value={r} />)}</datalist>
                                                    </div>
                                                </div>
                                                <input className="border w-full p-1 rounded" placeholder="詳細地址 (巷/弄/號/樓)" value={addrDetail} onChange={e => setAddrDetail(e.target.value)} />
                                            </div>
                                        ) : field.type === 'select' ? (
                                            <select className="border w-full p-1 rounded" value={editingData[field.key]||'男'} onChange={e=>setEditingData({...editingData,[field.key]:e.target.value})}>{field.options.map(o=><option key={o} value={o}>{o}</option>)}</select>
                                        ) : (
                                            <input type={field.type} className="border w-full p-1 rounded" value={editingData[field.key]||''} onChange={e=>setEditingData({...editingData,[field.key]:e.target.value})} required={field.required} />
                                        )}
                                    </div>
                                ))}
                                <div className="col-span-1 md:col-span-2 mt-4 flex justify-end space-x-3">
                                    <button type="button" onClick={() => setIsCustomerModalOpen(false)} className="px-4 py-2 border rounded">取消</button>
                                    <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded">儲存</button>
                                </div>
                            </form>
                        </Modal>
                    )}

                    {/* Prx Modal (New Layout - Full Fields) */}
                    {isPrxModalOpen && (
                        <Modal title={isViewOnly ? "驗光資料 (唯讀)" : (mode === 'add' ? "新增驗光資料" : "編輯驗光資料")} onClose={() => setIsPrxModalOpen(false)} size="large">
                            <form onSubmit={(e) => { e.preventDefault(); if(!isViewOnly) savePrx(); }} className="space-y-4">
                                <fieldset disabled={isViewOnly} className="space-y-4">
                                <div className="grid grid-cols-3 gap-2 bg-gray-50 p-2 rounded">
                                    <div><label className="text-xs font-bold text-gray-500">日期</label><input type="date" className="border w-full rounded p-1" value={editingData.DATE||''} onChange={e=>setEditingData({...editingData, DATE:e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-gray-500">編號</label><input className="border w-full rounded p-1 bg-gray-100" value={editingData.CID1||''} readOnly /></div>
                                    <div><label className="text-xs font-bold text-gray-500">姓名</label><input className="border w-full rounded p-1 bg-gray-100" value={editingData.NAME||''} readOnly /></div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="border border-red-200 rounded p-3 bg-red-50">
                                        <div className="font-bold text-red-800 mb-2 border-b border-red-200 text-lg">右眼 (R)</div>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div><label className="text-xs">球面 (SPH)</label><input className="border w-full rounded p-1" value={editingData.RSPH||''} onChange={e=>setEditingData({...editingData, RSPH:e.target.value})} /></div>
                                            <div><label className="text-xs">散光 (CYL)</label><input className="border w-full rounded p-1" value={editingData.RCYL||''} onChange={e=>setEditingData({...editingData, RCYL:e.target.value})} /></div>
                                            <div><label className="text-xs">角度 (AXIS)</label><input className="border w-full rounded p-1" value={editingData.RAXIS||''} onChange={e=>setEditingData({...editingData, RAXIS:e.target.value})} /></div>
                                            <div><label className="text-xs">老花 (ADD)</label><input className="border w-full rounded p-1" value={editingData.RADD||''} onChange={e=>setEditingData({...editingData, RADD:e.target.value})} /></div>
                                            <div><label className="text-xs">H-Prism (RBCH)</label><input className="border w-full rounded p-1" value={editingData.RBCH||''} onChange={e=>setEditingData({...editingData, RBCH:e.target.value})} /></div>
                                            <div><label className="text-xs">V-Prism (RBCV)</label><input className="border w-full rounded p-1" value={editingData.RBCV||''} onChange={e=>setEditingData({...editingData, RBCV:e.target.value})} /></div>
                                            <div><label className="text-xs">矯正前 (VA1)</label><input className="border w-full rounded p-1" value={editingData.RBRVISE1||''} onChange={e=>setEditingData({...editingData, RBRVISE1:e.target.value})} /></div>
                                            <div><label className="text-xs">矯正後 (VA2)</label><input className="border w-full rounded p-1" value={editingData.RBRVISE2||''} onChange={e=>setEditingData({...editingData, RBRVISE2:e.target.value})} /></div>
                                            <div className="col-span-3"><label className="text-xs">隱形眼鏡 (R-ITEM)</label><input className="border w-full rounded p-1" value={editingData.RITEM||''} onChange={e=>setEditingData({...editingData, RITEM:e.target.value})} /></div>
                                        </div>
                                    </div>
                                    <div className="border border-blue-200 rounded p-3 bg-blue-50">
                                        <div className="font-bold text-blue-800 mb-2 border-b border-blue-200 text-lg">左眼 (L)</div>
                                        <div className="grid grid-cols-3 gap-2">
                                            <div><label className="text-xs">球面 (SPH)</label><input className="border w-full rounded p-1" value={editingData.LSPH||''} onChange={e=>setEditingData({...editingData, LSPH:e.target.value})} /></div>
                                            <div><label className="text-xs">散光 (CYL)</label><input className="border w-full rounded p-1" value={editingData.LCYL||''} onChange={e=>setEditingData({...editingData, LCYL:e.target.value})} /></div>
                                            <div><label className="text-xs">角度 (AXIS)</label><input className="border w-full rounded p-1" value={editingData.LAXIS||''} onChange={e=>setEditingData({...editingData, LAXIS:e.target.value})} /></div>
                                            <div><label className="text-xs">老花 (ADD)</label><input className="border w-full rounded p-1" value={editingData.LADD||''} onChange={e=>setEditingData({...editingData, LADD:e.target.value})} /></div>
                                            <div><label className="text-xs">H-Prism (LBCH)</label><input className="border w-full rounded p-1" value={editingData.LBCH||''} onChange={e=>setEditingData({...editingData, LBCH:e.target.value})} /></div>
                                            <div><label className="text-xs">V-Prism (LBCV)</label><input className="border w-full rounded p-1" value={editingData.LBCV||''} onChange={e=>setEditingData({...editingData, LBCV:e.target.value})} /></div>
                                            <div><label className="text-xs">矯正前 (VA1)</label><input className="border w-full rounded p-1" value={editingData.LBRVISE1||''} onChange={e=>setEditingData({...editingData, LBRVISE1:e.target.value})} /></div>
                                            <div><label className="text-xs">矯正後 (VA2)</label><input className="border w-full rounded p-1" value={editingData.LBRVISE2||''} onChange={e=>setEditingData({...editingData, LBRVISE2:e.target.value})} /></div>
                                            <div className="col-span-3"><label className="text-xs">隱形眼鏡 (L-ITEM)</label><input className="border w-full rounded p-1" value={editingData.LITEM||''} onChange={e=>setEditingData({...editingData, LITEM:e.target.value})} /></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 border-t pt-4">
                                    <div><label className="text-xs font-bold text-gray-500">瞳距 (PD)</label><input className="border w-full rounded p-1" value={editingData.PD||''} onChange={e=>setEditingData({...editingData, PD:e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-gray-500">年齡 (AGE)</label><input type="number" className="border w-full rounded p-1" value={editingData.AGE||''} onChange={e=>setEditingData({...editingData, AGE:e.target.value})} /></div>
                                    <div className="col-span-2"><label className="text-xs font-bold text-gray-500">鏡框/鏡片 (ITEM)</label><input className="border w-full rounded p-1" value={editingData.ITEM||''} onChange={e=>setEditingData({...editingData, ITEM:e.target.value})} /></div>
                                    <div className="col-span-2 md:col-span-4"><label className="text-xs font-bold text-gray-500">備註 1 (REMARK)</label><input className="border w-full rounded p-1" value={editingData.REMARK||''} onChange={e=>setEditingData({...editingData, REMARK:e.target.value})} /></div>
                                    <div className="col-span-2 md:col-span-4"><label className="text-xs font-bold text-gray-500">備註 2 (REMARK2)</label><input className="border w-full rounded p-1" value={editingData.REMARK2||''} onChange={e=>setEditingData({...editingData, REMARK2:e.target.value})} /></div>
                                    <div className="col-span-2 md:col-span-4"><label className="text-xs font-bold text-gray-500">備註 3 (REMARK3)</label><input className="border w-full rounded p-1" value={editingData.REMARK3||''} onChange={e=>setEditingData({...editingData, REMARK3:e.target.value})} /></div>
                                </div>
                                </fieldset>

                                <div className="flex justify-end space-x-3 pt-4 border-t">
                                    <button type="button" onClick={() => setIsPrxModalOpen(false)} className="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">
                                        {isViewOnly ? "關閉" : "取消"}
                                    </button>
                                    {!isViewOnly && (
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">儲存</button>
                                    )}
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
