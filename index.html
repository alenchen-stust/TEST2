<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鐘錶眼鏡客戶管理系統</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            addDoc,
            deleteDoc,
            updateDoc,
            getDocs, 
            getDoc,
            query, 
            where,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose to window for React component
        window.firebaseModules = { 
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, 
            signInWithCustomToken, signInAnonymously,
            getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc, getDocs, getDoc, query, where, onSnapshot
        };
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons Definition ---
        const Icon = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>;
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
        const Edit = (props) => <Icon {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>;
        const LogOut = (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></Icon>;
        const FileSpreadsheet = (props) => <Icon {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></Icon>;
        const Settings = (props) => <Icon {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>;
        const Database = (props) => <Icon {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></Icon>;
        const Eye = (props) => <Icon {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></Icon>;
        const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></Icon>;
        const Lock = (props) => <Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></Icon>;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxtxWF-jQMMxvAeMjP5-HJ6y6_QBxLdsY",
            authDomain: "test1-1246d.firebaseapp.com",
            projectId: "test1-1246d",
            storageBucket: "test1-1246d.firebasestorage.app",
            messagingSenderId: "1046567528056",
            appId: "1:1046567528056:web:4e34594985c21d8892af8d",
            measurementId: "G-8JNGR22WDW"
        };

        // --- Initialize Firebase ---
        const { initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } = window.firebaseModules;
        const { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc, getDocs, getDoc, query, where, onSnapshot } = window.firebaseModules;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Gemini API Helper ---
        const callGeminiAPI = async (prompt) => {
            const apiKey = ""; // Provided by environment at runtime
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "無法產生 AI 回應";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "發生錯誤，請稍後再試";
            }
        };

        // --- Constants & Field Definitions ---
        const CMF_FIELDS = [
            { key: 'CID1', label: '客戶編號', type: 'text', required: true },
            { key: 'NAME', label: '客戶姓名', type: 'text', required: true },
            { key: 'SEX', label: '性別', type: 'select', options: ['男', '女', '其他'] },
            { key: 'TEL', label: '電話', type: 'tel' },
            { key: 'BIRDATE', label: '生日', type: 'date' },
            { key: 'ADDRESS', label: '地址', type: 'text', className: 'col-span-2' },
            { key: 'INDATE', label: '初訪日期', type: 'date' },
            { key: 'LASTD', label: '最後日期', type: 'date' },
            { key: 'CLASS', label: '備考', type: 'text' },
            { key: 'CLASS1', label: '備考1', type: 'text' },
            { key: 'SUM', label: '總計', type: 'number' },
        ];

        const PRXMF_FIELDS = [
            { key: 'DATE', label: '登錄日期', type: 'date' },
            { key: 'RSPH', label: '右眼球面(SPH)', type: 'text' },
            { key: 'RCYL', label: '右眼散光(CYL)', type: 'text' },
            { key: 'RAXIS', label: '右眼角度(AXIS)', type: 'text' },
            { key: 'RADD', label: '右眼老花(ADD)', type: 'text' },
            { key: 'RBCV', label: '右眼V', type: 'text' },
            { key: 'RBCH', label: '右眼H', type: 'text' },
            { key: 'LSPH', label: '左眼球面(SPH)', type: 'text' },
            { key: 'LCYL', label: '左眼散光(CYL)', type: 'text' },
            { key: 'LAXIS', label: '左眼角度(AXIS)', type: 'text' },
            { key: 'LADD', label: '左眼老花(ADD)', type: 'text' },
            { key: 'LBCV', label: '左眼V', type: 'text' },
            { key: 'LBCH', label: '左眼H', type: 'text' },
            { key: 'PD', label: '瞳距(PD)', type: 'text' },
            { key: 'ITEM', label: 'ITEM', type: 'text' },
            { key: 'RITEM', label: '隱形右眼', type: 'text' },
            { key: 'LITEM', label: '隱形左眼', type: 'text' },
            { key: 'RBRVISE1', label: '右眼矯正前', type: 'text' },
            { key: 'LBRVISE1', label: '左眼矯正前', type: 'text' },
            { key: 'RBRVISE2', label: '右眼矯正後', type: 'text' },
            { key: 'LBRVISE2', label: '左眼矯正後', type: 'text' },
            { key: 'REMARK', label: '備註一 (可使用 AI 建議)', type: 'text', className: 'col-span-3' },
            { key: 'REMARK2', label: '備註二', type: 'text', className: 'col-span-3' },
            { key: 'REMARK3', label: '備註三', type: 'text', className: 'col-span-3' },
            { key: 'AGE', label: '年齡', type: 'number' },
            { key: 'NUM', label: '筆數', type: 'number' },
        ];

        // --- Utility Components ---
        const LoadingSpinner = () => (
            <div className="flex justify-center items-center p-8">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        );

        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                        <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div className="p-6">
                        {children}
                    </div>
                </div>
            </div>
        );

        const AiResultModal = ({ result, onClose }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg border border-purple-200">
                    <div className="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 rounded-t-xl flex justify-between items-center text-white">
                        <h3 className="text-lg font-bold flex items-center">
                            <Sparkles className="w-5 h-5 mr-2 text-yellow-300" />
                            {result.title}
                        </h3>
                        <button onClick={onClose} className="hover:text-gray-200 text-2xl">&times;</button>
                    </div>
                    <div className="p-6">
                        <div className="bg-gray-50 p-4 rounded border border-gray-100 text-gray-700 leading-relaxed whitespace-pre-wrap">
                            {result.content}
                        </div>
                        <div className="mt-6 flex justify-end space-x-3">
                             <button 
                                onClick={() => {navigator.clipboard.writeText(result.content); alert('已複製內容');}}
                                className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded flex items-center"
                            >
                                複製內容
                            </button>
                            {result.onApply && (
                                <button 
                                    onClick={() => { result.onApply(result.content); onClose(); }}
                                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded flex items-center"
                                >
                                    填入備註
                                </button>
                            )}
                            <button onClick={onClose} className="px-4 py-2 border hover:bg-gray-50 rounded">關閉</button>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- Main Application Component ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [userRole, setUserRole] = useState(null); // 'admin', 'user', 'pending'
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('search');
            
            // Auth Error State
            const [authError, setAuthError] = useState(null);
            
            // Data State
            const [customers, setCustomers] = useState([]);
            const [allPrescriptions, setAllPrescriptions] = useState([]); // 2. 儲存所有驗光資料
            const [filteredCustomers, setFilteredCustomers] = useState([]);
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            
            // Derived State for Detail View
            const [customerPrescriptions, setCustomerPrescriptions] = useState([]);
            
            // Search State
            const [searchCriteria, setSearchCriteria] = useState({
                CID1: '', NAME: '', TEL: '', ADDRESS: '', BIRDATE: ''
            });
            const [hasSearched, setHasSearched] = useState(false);

            // Modal State
            const [isCustomerModalOpen, setIsCustomerModalOpen] = useState(false);
            const [isPrxModalOpen, setIsPrxModalOpen] = useState(false);
            const [editingData, setEditingData] = useState({});
            const [mode, setMode] = useState('add'); // 'add' or 'edit'

            // AI State
            const [aiResult, setAiResult] = useState(null);
            const [isAiLoading, setIsAiLoading] = useState(false);

            // Admin Panel State
            const [systemUsers, setSystemUsers] = useState([]);
            const [msg, setMsg] = useState({ text: '', type: '' });

            // --- Authentication & Initialization ---
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        const adminRef = collection(db, 'artifacts', appId, 'public', 'data', 'sys_users');
                        
                        // Hardcoded Predefined Admins
                        const PREDEFINED_ADMINS = ['alenchen@stust.edu.tw', 'v1277.chen@gmail.com.tw'];

                        // 1. Auto-register user if not exists (Fix for missing users in list)
                        try {
                            const snapshot = await getDocs(adminRef);
                            const allUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            const myUser = allUsers.find(u => u.email === currentUser.email);
                            
                            let currentRole = 'pending'; // Default role for new users

                            // If predefined admin, force admin role
                            if (PREDEFINED_ADMINS.includes(currentUser.email)) {
                                currentRole = 'admin';
                            } else if (myUser) {
                                // If user exists, use their role
                                currentRole = myUser.role || 'pending'; // fallback to pending if role missing
                            }

                            // Register or Update
                            if (!myUser) {
                                await addDoc(adminRef, {
                                    email: currentUser.email,
                                    role: currentRole,
                                    addedAt: new Date().toISOString()
                                });
                                console.log(`Auto-registered new user as ${currentRole}:`, currentUser.email);
                            } else if (PREDEFINED_ADMINS.includes(currentUser.email) && myUser.role !== 'admin') {
                                // Force update predefined admin
                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sys_users', myUser.id), { role: 'admin' });
                            }

                            // Set App State
                            setUserRole(currentRole);
                            setIsAdmin(currentRole === 'admin');

                        } catch (err) {
                            console.error("Error checking admin status:", err);
                            if (err.code === 'permission-denied') {
                                console.log("Permission denied when checking admin status.");
                            }
                        }
                    } else {
                        setIsAdmin(false);
                        setUserRole(null);
                        setCustomers([]);
                        setAllPrescriptions([]);
                        setSelectedCustomer(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // --- Data Listeners (CMF) ---
            useEffect(() => {
                if (!user || userRole === 'pending') return; // Block data access if pending
                
                setLoading(true);
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'CMF');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCustomers(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching customers:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user, userRole]);

            // --- Data Listeners (PRXMF - Fetch All for Counts & Robust Mapping) ---
            useEffect(() => {
                if (!user || userRole === 'pending') return; // Block data access if pending

                // 2. Fetch ALL prescriptions to allow counting and robust linking
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'PRXMF');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAllPrescriptions(data);
                }, (error) => console.error(error));
                
                return () => unsubscribe();
            }, [user, userRole]);

            // --- Update Customer Prescriptions when selected ---
            useEffect(() => {
                if (selectedCustomer && allPrescriptions.length > 0) {
                    // 3. Robust Linking: Compare as strings and trim whitespace
                    const matches = allPrescriptions.filter(p => 
                        String(p.CID1).trim() === String(selectedCustomer.CID1).trim()
                    );
                    matches.sort((a, b) => new Date(b.DATE) - new Date(a.DATE));
                    setCustomerPrescriptions(matches);
                } else {
                    setCustomerPrescriptions([]);
                }
            }, [selectedCustomer, allPrescriptions]);


            // --- Actions: Login/Logout ---
            const handleGoogleLogin = async () => {
                setAuthError(null);
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login Error:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        let domainToAuthorize = window.location.hostname;
                        if (window.location.protocol === 'blob:') {
                            try {
                                const cleanUrl = window.location.href.replace('blob:', '');
                                const urlObj = new URL(cleanUrl);
                                domainToAuthorize = urlObj.hostname;
                            } catch (e) {
                                domainToAuthorize = "無法自動解析，請參考下方完整網址";
                            }
                        }
                        setAuthError({
                            type: 'domain',
                            domain: domainToAuthorize,
                            fullUrl: window.location.href,
                            message: "此網域尚未授權"
                        });
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        console.log("User closed login popup");
                    } else {
                        setAuthError({
                            type: 'other',
                            message: `登入失敗 (${error.code}): ${error.message}`
                        });
                    }
                }
            };

            const handleLogout = () => signOut(auth);

            // --- Actions: Search ---
            const handleSearch = () => {
                const { CID1, NAME, TEL, ADDRESS, BIRDATE } = searchCriteria;
                const lowerName = NAME.toLowerCase();
                const lowerAddr = ADDRESS.toLowerCase();

                const filtered = customers.filter(c => {
                    const matchCID = CID1 ? String(c.CID1).includes(CID1) : true;
                    const matchName = NAME ? String(c.NAME || '').toLowerCase().includes(lowerName) : true;
                    const matchTel = TEL ? String(c.TEL || '').includes(TEL) : true;
                    const matchAddr = ADDRESS ? String(c.ADDRESS || '').toLowerCase().includes(lowerAddr) : true;
                    const matchBirth = BIRDATE ? c.BIRDATE === BIRDATE : true;
                    return matchCID && matchName && matchTel && matchAddr && matchBirth;
                });
                
                setFilteredCustomers(filtered);
                setHasSearched(true);
            };

            // --- Helper: Get Prescription Count ---
            const getPrxCount = (cid1) => {
                if (!cid1) return 0;
                return allPrescriptions.filter(p => String(p.CID1).trim() === String(cid1).trim()).length;
            };

            // --- Actions: AI Features ---
            const handleGenerateCareMessage = async (customer) => {
                if (!customer) return;
                setIsAiLoading(true);
                const prompt = `你是一位專業且親切的眼鏡行店長。請為客戶 ${customer.NAME} (上次光臨日期: ${customer.LASTD || '未知'}) 撰寫一則簡短的關懷簡訊。
                內容重點：
                1. 親切問候。
                2. 提醒定期檢查視力或保養眼鏡（若上次光臨超過半年）。
                3. 告知有新款式到貨，歡迎回店調整。
                語氣：溫暖、不強迫推銷。長度限制：80字以內。`;

                const result = await callGeminiAPI(prompt);
                setAiResult({ title: `✨ AI 關懷簡訊建議 (${customer.NAME})`, content: result });
                setIsAiLoading(false);
            };

            const handleAnalyzeVision = async () => {
                const d = editingData;
                const isEmpty = !d.RSPH && !d.LSPH && !d.AGE;
                if (isEmpty) {
                    alert("請先輸入至少部分驗光數據或年齡，AI 才能提供建議。");
                    return;
                }

                setIsAiLoading(true);
                const prompt = `請扮演專業驗光師，分析以下驗光數據並提供鏡片選擇建議：
                客戶年齡: ${d.AGE || '未知'}
                右眼 (R): SPH ${d.RSPH || '無'}, CYL ${d.RCYL || '無'}, AXIS ${d.RAXIS || '無'}
                左眼 (L): SPH ${d.LSPH || '無'}, CYL ${d.LCYL || '無'}, AXIS ${d.LAXIS || '無'}
                老花 (ADD): ${d.RADD || '無'}
                
                請提供一段約 80-100 字的簡短摘要，內容包括：
                1. 屈光狀態簡述 (如：高度近視、散光、老花)。
                2. 推薦鏡片類型 (如：高折射率、多焦、抗藍光等)。
                3. 一句視力保健小叮嚀。
                請直接輸出建議內容，不要有開場白。`;

                const result = await callGeminiAPI(prompt);
                setAiResult({ 
                    title: '✨ AI 視力分析與鏡片建議', 
                    content: result,
                    onApply: (text) => setEditingData(prev => ({ ...prev, REMARK: text }))
                });
                setIsAiLoading(false);
            };

            // --- Actions: Customer CRUD ---
            const openCustomerModal = (customer = null) => {
                if (customer) {
                    setMode('edit');
                    setEditingData({ ...customer });
                } else {
                    setMode('add');
                    setEditingData({ CID1: '', NAME: '', SEX: '男', INDATE: new Date().toISOString().split('T')[0] });
                }
                setIsCustomerModalOpen(true);
            };

            const saveCustomer = async () => {
                if (!isAdmin) return;
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'CMF');
                try {
                    if (mode === 'add') {
                        if (customers.some(c => c.CID1 === editingData.CID1)) {
                            alert('客戶編號已存在');
                            return;
                        }
                        await addDoc(colRef, editingData);
                    } else {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'CMF', editingData.id);
                        const { id, ...updateData } = editingData;
                        await updateDoc(docRef, updateData);
                    }
                    setIsCustomerModalOpen(false);
                    showMsg('客戶資料儲存成功', 'success');
                    if (hasSearched) handleSearch(); 
                } catch (e) {
                    console.error(e);
                    if (e.code === 'permission-denied') {
                        alert('【權限不足】\n請前往 Firebase Console > Firestore Database > Rules\n修改規則為 allow read, write: if request.auth != null;');
                    } else {
                        showMsg('儲存失敗', 'error');
                    }
                }
            };

            const deleteCustomer = async (id, cid1) => {
                if (!isAdmin || !confirm('確定要刪除此客戶及其所有驗光資料嗎？')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'CMF', id));
                    // 刪除關聯的 PRXMF
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'PRXMF'), where('CID1', '==', cid1));
                    const snapshot = await getDocs(q);
                    const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
                    await Promise.all(deletePromises);
                    
                    if (selectedCustomer?.id === id) setSelectedCustomer(null);
                    showMsg('刪除成功', 'success');
                    if (hasSearched) setFilteredCustomers(prev => prev.filter(c => c.id !== id));
                } catch (e) {
                    console.error(e);
                    showMsg('刪除失敗', 'error');
                }
            };

            // --- Actions: Prescription CRUD ---
            const openPrxModal = (prx = null) => {
                if (!selectedCustomer) return;
                if (prx) {
                    setMode('edit');
                    setEditingData({ ...prx });
                } else {
                    setMode('add');
                    setEditingData({ 
                        CID1: selectedCustomer.CID1,
                        NAME: selectedCustomer.NAME,
                        TEL: selectedCustomer.TEL,
                        DATE: new Date().toISOString().split('T')[0]
                    });
                }
                setIsPrxModalOpen(true);
            };

            const savePrx = async () => {
                if (!isAdmin) return;
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'PRXMF');
                try {
                    if (mode === 'add') {
                        await addDoc(colRef, editingData);
                    } else {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'PRXMF', editingData.id);
                        const { id, ...updateData } = editingData;
                        await updateDoc(docRef, updateData);
                    }
                    setIsPrxModalOpen(false);
                    if (selectedCustomer && editingData.DATE) {
                         const customerRef = doc(db, 'artifacts', appId, 'public', 'data', 'CMF', selectedCustomer.id);
                         await updateDoc(customerRef, { LASTD: editingData.DATE });
                    }
                    showMsg('驗光資料儲存成功', 'success');
                } catch (e) {
                    console.error(e);
                    showMsg('儲存失敗', 'error');
                }
            };

            const deletePrx = async (id) => {
                if (!isAdmin || !confirm('確定刪除此筆驗光紀錄？')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'PRXMF', id));
                    showMsg('刪除成功', 'success');
                } catch(e) {
                    showMsg('刪除失敗', 'error');
                }
            };


            // --- Admin: System Setup & User Management ---
            const initializeAdmin = async () => {
                if (!user) return;
                if (!confirm(`確定要將目前帳號 (${user.email}) 設為系統管理員嗎？`)) return;
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'sys_users');
                    const snapshot = await getDocs(usersRef);
                    const myUserDoc = snapshot.docs.find(d => d.data().email === user.email);

                    if (myUserDoc) {
                        const userData = myUserDoc.data();
                        if (userData.role === 'admin') {
                            alert('您已經是管理員了！');
                            setIsAdmin(true);
                        } else {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sys_users', myUserDoc.id), { role: 'admin' });
                            setIsAdmin(true);
                            alert('成功！已將您的權限提升為「管理員」。');
                        }
                        return;
                    }
                    if (!snapshot.empty) {
                        const admins = snapshot.docs.filter(d => d.data().role === 'admin');
                        if (admins.length > 0) {
                            alert(`系統初始化失敗：目前已有管理員。`);
                            return;
                        }
                    }
                    await addDoc(usersRef, {
                        email: user.email,
                        role: 'admin',
                        addedAt: new Date().toISOString()
                    });
                    setIsAdmin(true);
                    alert('系統初始化成功！');
                } catch (e) {
                    console.error(e);
                    if (e.code === 'permission-denied') alert('權限不足，請檢查 Firebase 規則。');
                    else alert('設定失敗：' + e.message);
                }
            };

            const fetchSystemUsers = async () => {
                if (!isAdmin) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'sys_users');
                const snap = await getDocs(q);
                setSystemUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
            };

            const addUser = async (email) => {
                if (!email) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'sys_users'), {
                    email, role: 'user', addedAt: new Date().toISOString()
                });
                fetchSystemUsers();
            };

            const removeUser = async (id) => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sys_users', id));
                fetchSystemUsers();
            };

            const updateUserRole = async (id, newRole) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sys_users', id), { role: newRole });
                    showMsg('權限修改成功', 'success');
                    fetchSystemUsers();
                } catch (e) {
                    console.error(e);
                    showMsg('權限修改失敗', 'error');
                }
            };

            // --- CSV Import/Export ---
            const exportCSV = (type) => {
                const data = type === 'CMF' ? customers : allPrescriptions; 
                if (data.length === 0) { alert('無資料可匯出'); return; }
                
                const headers = type === 'CMF' ? CMF_FIELDS.map(f => f.key) : PRXMF_FIELDS.map(f => f.key);
                if (type === 'PRXMF') headers.unshift('CID1', 'NAME');

                const csvContent = [
                    headers.join(','),
                    ...data.map(row => headers.map(fieldName => {
                        let val = row[fieldName] || '';
                        val = String(val).replace(/"/g, '""'); 
                        return `"${val}"`;
                    }).join(','))
                ].join('\n');

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `${type}_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportCSV = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setLoading(true);
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const text = evt.target.result;
                        const rows = text.split('\n').map(r => r.trim()).filter(r => r);
                        const headers = rows[0].split(',').map(h => h.replace(/"/g, '').trim());
                        
                        const batchData = [];
                        for (let i = 1; i < rows.length; i++) {
                            const values = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"'));
                            const obj = {};
                            headers.forEach((h, idx) => obj[h] = values[idx]);
                            batchData.push(obj);
                        }

                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', type);
                        let count = 0;
                        for (const d of batchData) {
                            await addDoc(colRef, d);
                            count++;
                        }
                        showMsg(`成功匯入 ${count} 筆資料`, 'success'); 
                        e.target.value = ''; 
                    } catch (err) {
                        console.error(err);
                        showMsg('匯入過程發生錯誤', 'error');
                    } finally {
                        setLoading(false);
                    }
                };
                reader.readAsText(file);
            };

            const showMsg = (text, type) => {
                setMsg({ text, type });
                setTimeout(() => setMsg({ text: '', type: '' }), 3000);
            };


            // --- Render ---
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100 relative">
                        {/* Auth Error Modal */}
                        {authError && authError.type === 'domain' && (
                            <div className="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[80] p-4">
                                <div className="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                                    <h3 className="text-xl font-bold text-red-600 mb-4 flex items-center">⚠️ 網域授權錯誤</h3>
                                    <div className="bg-gray-100 p-3 rounded text-lg font-mono border-2 border-blue-200 text-blue-800 select-all break-all mb-4">{authError.domain}</div>
                                    <div className="flex justify-end space-x-3">
                                        <button onClick={() => {navigator.clipboard.writeText(authError.domain); alert('已複製網域');}} className="px-4 py-2 bg-blue-100 text-blue-700 rounded">複製網域</button>
                                        <button onClick={() => setAuthError(null)} className="px-4 py-2 bg-gray-600 text-white rounded">關閉視窗</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {authError && authError.type === 'other' && (
                            <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50 shadow">
                                <span className="block sm:inline">{authError.message}</span>
                                <span className="absolute top-0 bottom-0 right-0 px-4 py-3" onClick={() => setAuthError(null)}>
                                    <svg className="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                                </span>
                            </div>
                        )}

                        <div className="bg-white p-8 rounded-lg shadow-lg text-center max-w-md w-full">
                            <Eye className="w-16 h-16 mx-auto text-blue-600 mb-4" />
                            <h1 className="text-2xl font-bold mb-2 text-gray-800">鐘錶眼鏡客戶管理系統</h1>
                            <p className="text-gray-500 mb-6">請登入以存取系統</p>
                            <button onClick={handleGoogleLogin} className="w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded flex items-center justify-center hover:bg-gray-50 transition shadow-sm">
                                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5 mr-2" /> 使用 Google 帳號登入
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col relative">
                    {/* Loading Overlay */}
                    {(isAiLoading || loading) && (
                        <div className="fixed inset-0 bg-black bg-opacity-30 z-[70] flex flex-col items-center justify-center text-white">
                             <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
                             <p className="text-lg font-semibold animate-pulse">{isAiLoading ? '✨ AI 正在思考中...' : '處理中...'}</p>
                        </div>
                    )}

                    {/* AI Result Modal */}
                    {aiResult && <AiResultModal result={aiResult} onClose={() => setAiResult(null)} />}

                    {/* Header */}
                    <header className="bg-blue-800 text-white p-4 shadow-md">
                        <div className="container mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-2 cursor-pointer" onClick={() => {setSelectedCustomer(null); setActiveTab('search');}}>
                                <Eye className="w-8 h-8" />
                                <h1 className="text-xl font-bold hidden md:block">客戶管理系統</h1>
                            </div>
                            <div className="flex items-center space-x-4">
                                <div className="text-sm text-blue-200 flex items-center">
                                    <User className="w-4 h-4 mr-1" />
                                    {user.displayName || user.email}
                                    {isAdmin && <span className="ml-2 bg-yellow-500 text-blue-900 text-xs px-2 py-0.5 rounded-full font-bold">管理員</span>}
                                    {userRole === 'pending' && <span className="ml-2 bg-gray-500 text-white text-xs px-2 py-0.5 rounded-full font-bold">未授權</span>}
                                </div>
                                <button onClick={handleLogout} className="text-blue-200 hover:text-white">
                                    <LogOut className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Navigation */}
                    <nav className="bg-white shadow border-b">
                        <div className="container mx-auto flex space-x-1">
                            <button 
                                className={`px-6 py-3 border-b-2 font-medium ${activeTab === 'search' && !selectedCustomer ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                onClick={() => { setSelectedCustomer(null); setActiveTab('search'); }}
                            >
                                客戶查詢
                            </button>
                            {selectedCustomer && (
                                <button className={`px-6 py-3 border-b-2 font-medium border-blue-600 text-blue-600`}>
                                    {selectedCustomer.NAME} 的資料
                                </button>
                            )}
                            {isAdmin && (
                                <button 
                                    className={`px-6 py-3 border-b-2 font-medium ${activeTab === 'admin' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                    onClick={() => { setSelectedCustomer(null); setActiveTab('admin'); fetchSystemUsers(); }}
                                >
                                    系統管理
                                </button>
                            )}
                        </div>
                    </nav>

                    {/* Toast Message */}
                    {msg.text && (
                        <div className={`fixed top-4 right-4 p-4 rounded shadow-lg z-50 text-white ${msg.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
                            {msg.text}
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="flex-1 container mx-auto p-4 overflow-y-auto">
                        
                        {/* Unauthorized View */}
                        {userRole === 'pending' && (
                            <div className="flex flex-col items-center justify-center h-full text-gray-500">
                                <Lock className="w-16 h-16 mb-4 text-gray-400" />
                                <h2 className="text-2xl font-bold text-gray-700 mb-2">帳號審核中</h2>
                                <p className="mb-4 text-center max-w-md">您的帳號目前尚未取得授權，無法使用查詢功能。<br/>請聯繫系統管理員為您開通權限。</p>
                                <div className="bg-gray-100 p-4 rounded border border-gray-200 text-sm">
                                    <span className="font-bold">您的帳號：</span> {user.email}
                                </div>
                            </div>
                        )}

                        {/* Search View */}
                        {activeTab === 'search' && !selectedCustomer && userRole !== 'pending' && (
                            <div className="space-y-6">
                                <div className="bg-white p-4 rounded shadow">
                                    <h2 className="text-lg font-semibold mb-4 flex items-center"><Search className="w-5 h-5 mr-2"/> 搜尋條件</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                                        <input placeholder="客戶編號" className="border p-2 rounded" value={searchCriteria.CID1} onChange={e => setSearchCriteria({...searchCriteria, CID1: e.target.value})} />
                                        <input placeholder="姓名" className="border p-2 rounded" value={searchCriteria.NAME} onChange={e => setSearchCriteria({...searchCriteria, NAME: e.target.value})} />
                                        <input placeholder="電話" className="border p-2 rounded" value={searchCriteria.TEL} onChange={e => setSearchCriteria({...searchCriteria, TEL: e.target.value})} />
                                        <input placeholder="地址" className="border p-2 rounded" value={searchCriteria.ADDRESS} onChange={e => setSearchCriteria({...searchCriteria, ADDRESS: e.target.value})} />
                                        <input type="date" className="border p-2 rounded" value={searchCriteria.BIRDATE} onChange={e => setSearchCriteria({...searchCriteria, BIRDATE: e.target.value})} />
                                        <button onClick={handleSearch} className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded flex justify-center items-center shadow">
                                            <Search className="w-5 h-5 mr-1" /> 搜尋
                                        </button>
                                    </div>
                                </div>

                                {/* Customer List Table (Hidden until searched) */}
                                {hasSearched && (
                                    <div className="bg-white p-4 rounded shadow fade-in">
                                        <div className="flex justify-between items-center mb-4">
                                            <h2 className="text-lg font-semibold">搜尋結果 ({filteredCustomers.length})</h2>
                                            {isAdmin && (
                                                <button onClick={() => openCustomerModal()} className="bg-blue-600 text-white px-4 py-2 rounded flex items-center hover:bg-blue-700">
                                                    <Plus className="w-4 h-4 mr-2" /> 新增客戶
                                                </button>
                                            )}
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full divide-y divide-gray-200">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">編號</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">性別</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">電話</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">生日</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">驗光筆數</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200">
                                                    {filteredCustomers.map(c => (
                                                        <tr key={c.id} className="hover:bg-gray-50">
                                                            <td className="px-4 py-3 whitespace-nowrap text-gray-900">{c.CID1}</td>
                                                            <td className="px-4 py-3 whitespace-nowrap text-blue-600 font-medium cursor-pointer hover:underline" onClick={() => setSelectedCustomer(c)}>
                                                                {c.NAME}
                                                            </td>
                                                            <td className="px-4 py-3 whitespace-nowrap text-gray-500">{c.SEX}</td>
                                                            <td className="px-4 py-3 whitespace-nowrap text-gray-500">{c.TEL}</td>
                                                            <td className="px-4 py-3 whitespace-nowrap text-gray-500">{c.BIRDATE}</td>
                                                            <td className="px-4 py-3 whitespace-nowrap text-gray-500 text-center">
                                                                <span className="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-bold">
                                                                    {getPrxCount(c.CID1)}
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-3 whitespace-nowrap text-gray-500 flex space-x-2">
                                                                <button onClick={() => setSelectedCustomer(c)} className="text-blue-600 hover:text-blue-800"><FileText className="w-4 h-4"/></button>
                                                                {isAdmin && (
                                                                    <>
                                                                        <button onClick={() => openCustomerModal(c)} className="text-green-600 hover:text-green-800"><Edit className="w-4 h-4"/></button>
                                                                        <button onClick={() => deleteCustomer(c.id, c.CID1)} className="text-red-600 hover:text-red-800"><Trash2 className="w-4 h-4"/></button>
                                                                    </>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {filteredCustomers.length === 0 && (
                                                        <tr>
                                                            <td colSpan="7" className="text-center py-8 text-gray-400">無符合搜尋條件的資料</td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                                {!hasSearched && (
                                    <div className="text-center text-gray-400 mt-10">
                                        請輸入條件並點擊「搜尋」按鈕以查詢資料
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Customer Detail View */}
                        {selectedCustomer && (
                            <div className="space-y-6 fade-in">
                                {/* Basic Info Card */}
                                <div className="bg-white p-6 rounded shadow-lg border-l-4 border-blue-600 relative">
                                    <div className="flex justify-between items-start mb-4">
                                        <h2 className="text-2xl font-bold text-gray-800">{selectedCustomer.NAME} <span className="text-lg text-gray-500 font-normal">({selectedCustomer.CID1})</span></h2>
                                        <div className="flex space-x-2">
                                            <button 
                                                onClick={() => handleGenerateCareMessage(selectedCustomer)} 
                                                className="bg-purple-100 text-purple-700 hover:bg-purple-200 px-3 py-2 rounded flex items-center transition shadow-sm border border-purple-200"
                                            >
                                                <Sparkles className="w-4 h-4 mr-2" /> 生成關懷簡訊
                                            </button>
                                            {isAdmin && (
                                                <button onClick={() => openCustomerModal(selectedCustomer)} className="text-blue-600 hover:bg-blue-50 p-2 rounded">
                                                    <Edit className="w-5 h-5"/>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                                        <div><span className="text-gray-500 block">電話</span> <span className="text-lg">{selectedCustomer.TEL}</span></div>
                                        <div><span className="text-gray-500 block">生日</span> <span className="text-lg">{selectedCustomer.BIRDATE}</span></div>
                                        <div><span className="text-gray-500 block">性別</span> <span className="text-lg">{selectedCustomer.SEX}</span></div>
                                        <div className="col-span-1 md:col-span-3"><span className="text-gray-500 block">地址</span> <span className="text-lg">{selectedCustomer.ADDRESS}</span></div>
                                        <div><span className="text-gray-500 block">初訪</span> {selectedCustomer.INDATE}</div>
                                        <div><span className="text-gray-500 block">最後光臨</span> {selectedCustomer.LASTD}</div>
                                        <div><span className="text-gray-500 block">消費總計</span> {selectedCustomer.SUM}</div>
                                        <div className="col-span-1 md:col-span-3 bg-gray-50 p-2 rounded">
                                            <span className="text-gray-500 font-bold">備考:</span> {selectedCustomer.CLASS} {selectedCustomer.CLASS1}
                                        </div>
                                    </div>
                                </div>

                                {/* Prescriptions List */}
                                <div className="bg-white p-4 rounded shadow">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <h3 className="text-xl font-bold text-gray-700 flex items-center"><Database className="w-5 h-5 mr-2"/> 驗光紀錄</h3>
                                        {isAdmin && (
                                            <button onClick={() => openPrxModal()} className="bg-green-600 text-white px-4 py-2 rounded flex items-center hover:bg-green-700 shadow">
                                                <Plus className="w-4 h-4 mr-2" /> 新增驗光
                                            </button>
                                        )}
                                    </div>

                                    <div className="space-y-4">
                                        {customerPrescriptions.map(prx => (
                                            <div key={prx.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="font-bold text-lg text-blue-800">{prx.DATE}</div>
                                                    {isAdmin && (
                                                        <div className="flex space-x-2">
                                                            <button onClick={() => openPrxModal(prx)} className="p-1 text-gray-500 hover:text-blue-600"><Edit className="w-4 h-4"/></button>
                                                            <button onClick={() => deletePrx(prx.id)} className="p-1 text-gray-500 hover:text-red-600"><Trash2 className="w-4 h-4"/></button>
                                                        </div>
                                                    )}
                                                </div>
                                                
                                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 text-sm">
                                                    {/* Right Eye */}
                                                    <div className="bg-red-50 p-3 rounded">
                                                        <div className="font-bold text-red-800 border-b border-red-200 mb-2">R (右眼)</div>
                                                        <div className="grid grid-cols-4 gap-2">
                                                            <div><span className="text-xs text-gray-500 block">SPH</span>{prx.RSPH}</div>
                                                            <div><span className="text-xs text-gray-500 block">CYL</span>{prx.RCYL}</div>
                                                            <div><span className="text-xs text-gray-500 block">AXIS</span>{prx.RAXIS}</div>
                                                            <div><span className="text-xs text-gray-500 block">ADD</span>{prx.RADD}</div>
                                                            <div><span className="text-xs text-gray-500 block">V</span>{prx.RBCV}</div>
                                                            <div><span className="text-xs text-gray-500 block">H</span>{prx.RBCH}</div>
                                                            <div className="col-span-2"><span className="text-xs text-gray-500 block">隱形</span>{prx.RITEM}</div>
                                                            <div className="col-span-2"><span className="text-xs text-gray-500 block">矯正前</span>{prx.RBRVISE1}</div>
                                                            <div className="col-span-2"><span className="text-xs text-gray-500 block">矯正後</span>{prx.RBRVISE2}</div>
                                                        </div>
                                                    </div>

                                                    {/* Left Eye */}
                                                    <div className="bg-blue-50 p-3 rounded">
                                                        <div className="font-bold text-blue-800 border-b border-blue-200 mb-2">L (左眼)</div>
                                                        <div className="grid grid-cols-4 gap-2">
                                                            <div><span className="text-xs text-gray-500 block">SPH</span>{prx.LSPH}</div>
                                                            <div><span className="text-xs text-gray-500 block">CYL</span>{prx.LCYL}</div>
                                                            <div><span className="text-xs text-gray-500 block">AXIS</span>{prx.LAXIS}</div>
                                                            <div><span className="text-xs text-gray-500 block">ADD</span>{prx.LADD}</div>
                                                            <div><span className="text-xs text-gray-500 block">V</span>{prx.LBCV}</div>
                                                            <div><span className="text-xs text-gray-500 block">H</span>{prx.LBCH}</div>
                                                            <div className="col-span-2"><span className="text-xs text-gray-500 block">隱形</span>{prx.LITEM}</div>
                                                            <div className="col-span-2"><span className="text-xs text-gray-500 block">矯正前</span>{prx.LBRVISE1}</div>
                                                            <div className="col-span-2"><span className="text-xs text-gray-500 block">矯正後</span>{prx.LBRVISE2}</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="mt-3 grid grid-cols-2 gap-4 text-xs text-gray-600 bg-gray-50 p-2 rounded">
                                                    <div><span className="font-bold">PD:</span> {prx.PD}</div>
                                                    <div><span className="font-bold">AGE:</span> {prx.AGE}</div>
                                                    <div className="col-span-2"><span className="font-bold">ITEM:</span> {prx.ITEM}</div>
                                                    <div className="col-span-2 border-t pt-1">{prx.REMARK}</div>
                                                    <div className="col-span-2">{prx.REMARK2}</div>
                                                    <div className="col-span-2">{prx.REMARK3}</div>
                                                </div>
                                            </div>
                                        ))}
                                        {customerPrescriptions.length === 0 && <div className="text-center text-gray-400 py-4">尚無驗光紀錄</div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Admin Panel */}
                        {activeTab === 'admin' && isAdmin && (
                            <div className="space-y-6">
                                {/* System Setup (If needed) */}
                                <div className="bg-white p-6 rounded shadow">
                                    <h2 className="text-lg font-bold mb-4 flex items-center"><Settings className="w-5 h-5 mr-2"/> 資料管理</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="border p-4 rounded">
                                            <h3 className="font-semibold mb-2 text-blue-600">客戶資料 (CMF)</h3>
                                            <div className="flex flex-col space-y-2">
                                                <button onClick={() => exportCSV('CMF')} className="bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 px-4 rounded flex items-center justify-center">
                                                    <FileSpreadsheet className="w-4 h-4 mr-2"/> 匯出 CSV
                                                </button>
                                                <label className="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded flex items-center justify-center cursor-pointer">
                                                    <Database className="w-4 h-4 mr-2"/> 匯入 CSV
                                                    <input type="file" accept=".csv" className="hidden" onChange={(e) => handleImportCSV(e, 'CMF')} />
                                                </label>
                                            </div>
                                        </div>
                                        <div className="border p-4 rounded">
                                            <h3 className="font-semibold mb-2 text-green-600">驗光資料 (PRXMF)</h3>
                                            <div className="flex flex-col space-y-2">
                                                <button onClick={() => exportCSV('PRXMF')} className="bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 px-4 rounded flex items-center justify-center">
                                                    <FileSpreadsheet className="w-4 h-4 mr-2"/> 匯出 CSV
                                                </button>
                                                <label className="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded flex items-center justify-center cursor-pointer">
                                                    <Database className="w-4 h-4 mr-2"/> 匯入 CSV
                                                    <input type="file" accept=".csv" className="hidden" onChange={(e) => handleImportCSV(e, 'PRXMF')} />
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded shadow">
                                    <h2 className="text-lg font-bold mb-4">使用者權限管理</h2>
                                    <div className="flex gap-2 mb-4">
                                        <input type="email" id="new-user-email" placeholder="輸入使用者 Email" className="border p-2 rounded flex-1" />
                                        <button onClick={() => {
                                            const input = document.getElementById('new-user-email');
                                            addUser(input.value);
                                            input.value = '';
                                        }} className="bg-blue-600 text-white px-4 py-2 rounded">新增使用者</button>
                                    </div>
                                    <ul className="divide-y">
                                        {systemUsers.map(u => (
                                            <li key={u.id} className="py-3 flex justify-between items-center">
                                                <div>
                                                    <span className="font-medium">{u.email}</span>
                                                    {/* Show current role badge */}
                                                    <span className={`ml-2 text-xs px-2 py-1 rounded ${
                                                        u.role === 'admin' ? 'bg-yellow-100 text-yellow-800' : 
                                                        u.role === 'pending' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {u.role === 'admin' ? '管理員' : u.role === 'pending' ? '未授權' : '一般使用者'}
                                                    </span>
                                                </div>
                                                
                                                <div className="flex items-center space-x-3">
                                                    {/* Role modification dropdown */}
                                                    <select 
                                                        value={u.role} 
                                                        onChange={(e) => updateUserRole(u.id, e.target.value)}
                                                        className="border rounded p-1 text-sm bg-white"
                                                    >
                                                        <option value="pending">未授權</option>
                                                        <option value="user">一般使用者</option>
                                                        <option value="admin">管理員</option>
                                                    </select>

                                                    {/* Prevent deleting oneself if single admin maybe? But for now allow delete except hardcoded prevention usually in backend. Front end just allows delete. */}
                                                    <button onClick={() => removeUser(u.id)} className="text-red-600 hover:text-red-800 text-sm">刪除</button>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        )}

                        {/* Admin Init Helper (Only visible if no Admin exists) */}
                        {activeTab === 'search' && !isAdmin && (
                            <div className="mt-10 text-center">
                                <button onClick={initializeAdmin} className="text-xs text-gray-300 hover:text-gray-500">系統初始化(設為管理員)</button>
                            </div>
                        )}

                    </main>

                    {/* Modals (Customer & Prx) */}
                    {isCustomerModalOpen && (
                        <Modal title={mode === 'add' ? "新增客戶" : "編輯客戶"} onClose={() => setIsCustomerModalOpen(false)}>
                            <form onSubmit={(e) => { e.preventDefault(); saveCustomer(); }} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {CMF_FIELDS.map(field => (
                                    <div key={field.key} className={field.className || ''}>
                                        <label className="block text-sm font-medium text-gray-700">{field.label}</label>
                                        {field.type === 'select' ? (
                                            <select 
                                                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                                value={editingData[field.key] || '男'}
                                                onChange={e => setEditingData({...editingData, [field.key]: e.target.value})}
                                            >
                                                {field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                            </select>
                                        ) : (
                                            <input 
                                                type={field.type}
                                                className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                                value={editingData[field.key] || ''}
                                                onChange={e => setEditingData({...editingData, [field.key]: e.target.value})}
                                                required={field.required}
                                            />
                                        )}
                                    </div>
                                ))}
                                <div className="col-span-1 md:col-span-2 mt-4 flex justify-end space-x-3">
                                    <button type="button" onClick={() => setIsCustomerModalOpen(false)} className="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">取消</button>
                                    <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">儲存</button>
                                </div>
                            </form>
                        </Modal>
                    )}

                    {isPrxModalOpen && (
                        <Modal title={mode === 'add' ? "新增驗光資料" : "編輯驗光資料"} onClose={() => setIsPrxModalOpen(false)}>
                            <form onSubmit={(e) => { e.preventDefault(); savePrx(); }} className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {PRXMF_FIELDS.map(field => (
                                    <div key={field.key} className={field.className || ''}>
                                        <label className="block text-xs font-bold text-gray-500">{field.label}</label>
                                        <input 
                                            type={field.type}
                                            className="mt-1 block w-full border border-gray-300 rounded p-1.5 text-sm focus:border-blue-500"
                                            value={editingData[field.key] || ''}
                                            onChange={e => setEditingData({...editingData, [field.key]: e.target.value})}
                                        />
                                    </div>
                                ))}
                                {/* AI Analyze Button (Only show in Edit/Add mode) */}
                                <div className="col-span-2 md:col-span-4 flex items-center justify-between border-t pt-4 mt-2">
                                     <button 
                                        type="button" 
                                        onClick={handleAnalyzeVision}
                                        className="text-purple-600 hover:bg-purple-50 px-3 py-2 rounded flex items-center text-sm font-semibold border border-purple-200 shadow-sm"
                                    >
                                        <Sparkles className="w-4 h-4 mr-2" /> AI 鏡片建議
                                    </button>

                                    <div className="flex space-x-3">
                                        <button type="button" onClick={() => setIsPrxModalOpen(false)} className="px-4 py-2 border rounded text-gray-600 hover:bg-gray-50">取消</button>
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">儲存</button>
                                    </div>
                                </div>
                            </form>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
